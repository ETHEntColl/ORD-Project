<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gaussian Splats 3D Viewer</title>
  <style>
    html, body { margin: 0; width: 100%; height: 100%; overflow: hidden; }

    /* logo */
    .logo {
      position: fixed; top: 16px; left: 16px;
      width: 140px; height: auto; z-index: 10; user-select: none;
    }

    /* top-right controls */
    #controls {
      position: fixed; top: 16px; right: 16px; z-index: 12;
      display: flex; gap: 8px; align-items: center;
      background: rgba(255,255,255,.9); padding: 8px 10px; border-radius: 10px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    #pick-btn, #clear-current-btn, #clear-all-btn {
      padding: 6px 10px; border-radius: 8px; border: 0; cursor: pointer; background: #f2f2f2;
    }
    #model-select { max-width: 40vw; }

    /* drag overlay (visible while dragging a file over the window) */
    #drop-overlay {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,.35); color: #fff; font: 600 18px/1.2 system-ui, sans-serif;
      z-index: 20; opacity: 0; pointer-events: none; transition: opacity .15s ease;
    }
    #drop-overlay.show { opacity: 1; pointer-events: auto; }

    /* startup hint (visible when no model loaded) */
    #hint-overlay {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      padding: 16px; text-align: center; color: #fff; z-index: 5;
      font: 600 18px/1.3 system-ui, sans-serif; pointer-events: none;
      background: linear-gradient(to bottom, rgba(0,0,0,.35), rgba(0,0,0,.35));
    }
  </style>
</head>
<body>

  <!-- logo -->
  <a href="https://biocommunication.org/" target="_blank" rel="noreferrer">
    <img class="logo" src="./biocomm_logo.png" alt="Biocomm Logo">
  </a>

  <!-- controls -->
  <div id="controls">
    <button id="pick-btn" type="button">Load file</button>
    <select id="model-select" style="display:none"></select>
    <button id="clear-current-btn" type="button" style="display:none">Clear current</button>
    <button id="clear-all-btn" type="button" style="display:none">Clear all</button>
  </div>
  <input id="file-input" type="file" accept=".ply,.ksplat,.splat" style="display:none" />

  <!-- overlays -->
  <div id="drop-overlay">Drop a .ply / .ksplat / .splat file</div>
  <div id="hint-overlay">
    Drag and drop a .ply, .splat or .ksplat file here! (or use the load button in the top right corner)
  </div>

  <!-- viewer root -->
  <div id="viewer-container"></div>

  <script type="module">
    import * as GaussianSplats3D from './gaussian-splats-3d.module.js';

    const container       = document.getElementById('viewer-container');
    const dropOverlay     = document.getElementById('drop-overlay');
    const hintOverlay     = document.getElementById('hint-overlay');
    const fileInput       = document.getElementById('file-input');
    const pickBtn         = document.getElementById('pick-btn');
    const modelSelect     = document.getElementById('model-select');
    const clearCurrentBtn = document.getElementById('clear-current-btn');
    const clearAllBtn     = document.getElementById('clear-all-btn');

    const models = []; // { id, name, url, format, isBlob }
    let currentId = null;
    let viewer = null;

    function extToFormat(ext) {
      const e = ext.toLowerCase();
      if (e === 'ply')    return GaussianSplats3D.SceneFormat.Ply;
      if (e === 'ksplat') return GaussianSplats3D.SceneFormat.KSplat;
      if (e === 'splat')  return GaussianSplats3D.SceneFormat.Splat;
      return undefined;
    }

    function updateDropdown() {
      modelSelect.innerHTML = '';
      for (const m of models) {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        if (m.id === currentId) opt.selected = true;
        modelSelect.appendChild(opt);
      }
      modelSelect.style.display = models.length > 1 ? '' : 'none';
    }

    function updateButtons() {
      const hasAny  = models.length > 0;
      const hasMany = models.length > 1;

      clearCurrentBtn.style.display = hasAny ? '' : 'none';
      clearAllBtn.style.display     = hasMany ? '' : 'none';
      hintOverlay.style.display     = hasAny ? 'none' : '';
    }

    function addModel({name, url, format, isBlob}) {
      const id = Math.random().toString(36).slice(2);
      models.push({ id, name, url, format, isBlob: !!isBlob });
      return id;
    }

    function removeModelById(id) {
      const idx = models.findIndex(m => m.id === id);
      if (idx !== -1) {
        const m = models[idx];
        if (m.isBlob) { try { URL.revokeObjectURL(m.url); } catch {} }
        models.splice(idx, 1);
      }
    }

    async function replaceViewerWith(model) {
      // Dispose old viewer and clear container to truly replace
      if (viewer) { try { viewer.dispose(); } catch {} }
      container.replaceChildren();
      viewer = null;

      viewer = new GaussianSplats3D.Viewer({
        sharedMemoryForWorkers: false,
        container,
        cameraUp: [0, -1, -0.6],
        initialCameraPosition: [-1, -4, 6],
        initialCameraLookAt: [0, 4, 0]
      });

      await viewer.addSplatScene(model.url, {
        format: model.format,
        showLoadingUI: true,
        progressiveLoad: true,
        position: [0, 0, 0],
        rotation: [0, 0, 0, 1],
        scale: [1, 1, 1]
      });

      viewer.start();
      currentId = model.id;
      updateDropdown();
      updateButtons();
    }

    async function loadFile(file) {
      if (!file) return;
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      const format = extToFormat(ext);
      if (!format) {
        alert('Unsupported file type. Please use .ply, .ksplat, or .splat');
        return;
      }
      const url = URL.createObjectURL(file);
      const id  = addModel({ name: file.name, url, format, isBlob: true });
      const model = models.find(m => m.id === id);
      await replaceViewerWith(model);
    }

    // Drag & drop
    window.addEventListener('dragover', (e) => { e.preventDefault(); dropOverlay.classList.add('show'); });
    window.addEventListener('dragleave', (e) => {
      if (e.target === document || e.clientX <= 0 || e.clientY <= 0 ||
          e.clientX >= window.innerWidth || e.clientY >= window.innerHeight) {
        dropOverlay.classList.remove('show');
      }
    });
    window.addEventListener('drop', (e) => {
      e.preventDefault();
      dropOverlay.classList.remove('show');
      loadFile(e.dataTransfer?.files?.[0]);
    });

    // Picker
    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => loadFile(e.target.files?.[0]));

    // Dropdown → switch model (replace)
    modelSelect.addEventListener('change', async (e) => {
      const id = e.target.value;
      const model = models.find(m => m.id === id);
      if (model) await replaceViewerWith(model);
    });

    // Clear current
    clearCurrentBtn.addEventListener('click', async () => {
      if (!currentId) return;
      const idx = models.findIndex(m => m.id === currentId);
      removeModelById(currentId);

      if (models.length === 0) {
        // nothing left → dispose and show hint
        if (viewer) { try { viewer.dispose(); } catch {} }
        container.replaceChildren();
        viewer = null;
        currentId = null;
        updateDropdown();
        updateButtons();
        return;
      }

      // choose a replacement (next item at same index, or last one)
      const nextIdx = Math.min(idx, models.length - 1);
      const nextModel = models[nextIdx];
      await replaceViewerWith(nextModel);
    });

    // Clear all
    clearAllBtn.addEventListener('click', () => {
      for (const m of models) { if (m.isBlob) { try { URL.revokeObjectURL(m.url); } catch {} } }
      models.length = 0;
      currentId = null;
      if (viewer) { try { viewer.dispose(); } catch {} }
      container.replaceChildren();
      viewer = null;
      updateDropdown();
      updateButtons();
    });

    // Cleanup blob URLs on unload (just in case)
    window.addEventListener('beforeunload', () => {
      for (const m of models) { if (m.isBlob) { try { URL.revokeObjectURL(m.url); } catch {} } }
    });

    // Initial UI state: no model loaded
    updateDropdown();
    updateButtons();
  </script>
</body>
</html>
